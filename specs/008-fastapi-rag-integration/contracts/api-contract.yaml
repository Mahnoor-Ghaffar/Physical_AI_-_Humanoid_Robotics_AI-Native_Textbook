# API Contract: FastAPI RAG System Integration

## Overview
OpenAPI specification for the FastAPI RAG integration API.

## Endpoints

### POST /query
Process a user query through the RAG agent system and return the response.

#### Request
**Content-Type**: `application/json`

**Schema**:
```json
{
  "type": "object",
  "properties": {
    "query": {
      "type": "string",
      "description": "The user's question or query text",
      "minLength": 1,
      "maxLength": 10000
    },
    "timeout": {
      "type": "integer",
      "description": "Timeout in seconds for query processing",
      "minimum": 1,
      "maximum": 300,
      "default": 30
    },
    "stream": {
      "type": "boolean",
      "description": "Whether to stream the response",
      "default": false
    }
  },
  "required": ["query"],
  "additionalProperties": false
}
```

**Example**:
```json
{
  "query": "What are the key concepts in chapter 1?",
  "timeout": 60,
  "stream": false
}
```

#### Responses

**200 OK - Successful Response**
**Content-Type**: `application/json`

```json
{
  "type": "object",
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for the response",
      "format": "uuid"
    },
    "query": {
      "type": "string",
      "description": "The original query text"
    },
    "answer": {
      "type": "string",
      "description": "The agent's answer to the query"
    },
    "sources": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "title": {"type": "string"},
          "url": {"type": "string", "format": "uri"}
        }
      },
      "description": "List of sources used in the response"
    },
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Confidence score between 0 and 1"
    },
    "processing_time": {
      "type": "number",
      "minimum": 0,
      "description": "Time taken to process the query in seconds"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of response creation"
    },
    "status": {
      "type": "string",
      "enum": ["success", "error"],
      "description": "Status of the response"
    }
  },
  "required": ["id", "query", "answer", "timestamp", "status"],
  "additionalProperties": false
}
```

**Example**:
```json
{
  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "query": "What are the key concepts in chapter 1?",
  "answer": "Chapter 1 introduces the fundamental concepts of AI native applications...",
  "sources": [
    {
      "title": "Chapter 1: Introduction",
      "url": "https://example.com/book/chapter1"
    }
  ],
  "confidence": 0.85,
  "processing_time": 2.45,
  "timestamp": "2026-01-15T23:30:00Z",
  "status": "success"
}
```

**200 OK - Streaming Response** (when stream=true)
**Content-Type**: `text/plain` (streamed response)

The response is streamed as newline-delimited JSON objects:
```
{"id": "chunk-1", "content": "Chapter 1", "index": 0, "is_final": false, "timestamp": "2026-01-15T23:30:00Z"}
{"id": "chunk-2", "content": "introduces the fundamental", "index": 1, "is_final": false, "timestamp": "2026-01-15T23:30:01Z"}
{"id": "chunk-final", "content": "concepts of AI native applications...", "index": 2, "is_final": true, "timestamp": "2026-01-15T23:30:02Z"}
```

**400 Bad Request**
**Content-Type**: `application/json`

```json
{
  "type": "object",
  "properties": {
    "error": {
      "type": "string",
      "description": "Error message"
    },
    "code": {
      "type": "string",
      "description": "Error code"
    },
    "details": {
      "type": "object",
      "description": "Additional error details"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of error"
    }
  },
  "required": ["error", "code", "timestamp"],
  "additionalProperties": false
}
```

**500 Internal Server Error**
**Content-Type**: `application/json`

```json
{
  "type": "object",
  "properties": {
    "error": {
      "type": "string",
      "description": "Error message"
    },
    "code": {
      "type": "string",
      "description": "Error code"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of error"
    }
  },
  "required": ["error", "code", "timestamp"],
  "additionalProperties": false
}
```

## Error Codes

| Code | Description |
|------|-------------|
| `INVALID_QUERY` | Query parameter is invalid or missing |
| `QUERY_TOO_LONG` | Query exceeds maximum allowed length |
| `TIMEOUT_EXCEEDED` | Query processing exceeded timeout |
| `AGENT_ERROR` | Error occurred in RAG agent processing |
| `SERVICE_UNAVAILABLE` | RAG system is temporarily unavailable |
| `INTERNAL_ERROR` | Internal server error occurred |

## Security
- All endpoints require valid JSON content type
- Input validation performed on all parameters
- Error messages do not expose sensitive system information